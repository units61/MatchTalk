// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(uuid())
  email            String            @unique
  name             String
  gender           String
  hashedPassword   String
  avatar           String?
  xp               Int               @default(0)
  level            Int               @default(1)
  role             String            @default("user") // user, admin, moderator
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  roomParticipants RoomParticipant[]
  friendships      Friendship[]      @relation("UserFriendships")
  friendOf         Friendship[]      @relation("FriendFriendships")
  invitesSent      Invite[]          @relation("Inviter")
  invitesReceived  Invite[]          @relation("Invitee")
  matchQueues      MatchQueue[]
  badges           UserBadge[]
  notifications    Notification[]
  analyticsEvents  AnalyticsEvent[]

  @@index([email])
  @@index([xp])
  @@index([level])
  @@map("User")
}

model Room {
  id              String            @id @default(uuid())
  name            String
  category        String
  maxParticipants Int               @default(8)
  durationSec     Int               @default(300)
  timeLeftSec     Int               @default(300)
  extended        Boolean           @default(false)
  extensionYes    Int               @default(0)
  extensionNo     Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  participants    RoomParticipant[]

  @@index([timeLeftSec])
  @@index([category])
  @@map("Room")
}

model RoomParticipant {
  id       String   @id @default(uuid())
  userId   String
  roomId   String
  joinedAt DateTime @default(now())
  room     Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roomId])
  @@index([roomId])
  @@index([userId])
  @@map("RoomParticipant")
}

model Friendship {
  id        String   @id @default(uuid())
  userId    String
  friendId  String
  createdAt DateTime @default(now())
  user      User     @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)
  friend    User     @relation("FriendFriendships", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([friendId])
  @@index([userId])
  @@map("Friendship")
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Invite {
  id           String       @id @default(uuid())
  inviterId    String
  inviteeEmail String
  inviteeId    String?
  roomId       String?
  status       InviteStatus @default(PENDING)
  createdAt    DateTime     @default(now())
  respondedAt  DateTime?
  inviter      User         @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee      User?        @relation("Invitee", fields: [inviteeId], references: [id], onDelete: SetNull)

  @@index([inviterId])
  @@index([inviteeId])
  @@index([roomId])
  @@index([status])
  @@map("Invite")
}

model Badge {
  id          String      @id @default(uuid())
  name        String      @unique
  description String
  icon        String
  xpReward    Int         @default(0)
  createdAt   DateTime    @default(now())
  users       UserBadge[]

  @@map("Badge")
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("UserBadge")
}

enum QueueStatus {
  WAITING
  MATCHED
  LEFT
}

model MatchQueue {
  id        String      @id @default(uuid())
  userId    String
  status    QueueStatus @default(WAITING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("MatchQueue")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  data      String?  @default("{}") // JSON string
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("Notification")
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  userId    String?
  eventType String
  eventData String   @default("{}") // JSON string
  metadata  String?  @default("{}") // JSON string
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("AnalyticsEvent")
}
